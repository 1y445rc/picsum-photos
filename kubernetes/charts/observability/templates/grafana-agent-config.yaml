kind: ConfigMap
metadata:
  name: grafana-agent
apiVersion: v1
data:
  agent.yaml: |
    metrics:
      wal_directory: /var/lib/agent/wal
      global:
        scrape_interval: 60s
        external_labels:
          cluster: cloud
      configs:
      - name: integrations
        remote_write:
        - url: https://prometheus-prod-01-eu-west-0.grafana.net/api/prom/push
          basic_auth:
            username: ${GRAFANA_USERNAME}
            password: ${GRAFANA_PASSWORD}
        scrape_configs:
        - job_name: spanmetrics
          static_configs:
            - targets: ['127.0.0.1:81']
          metric_relabel_configs:
            - source_labels: [operation]
              target_label: span_name
            - source_labels: [service_name]
              target_label: service
            - regex: operation
              action: labeldrop
            - regex: service_name
              action: labeldrop

        - job_name: "kubernetes-pods"
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_annotation_observability_scrape]
              action: keep
              regex: true
            - source_labels: [__meta_kubernetes_pod_annotation_observability_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_observability_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: namespace
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: pod

    traces:
      configs:
      - name: default

        spanmetrics:
          handler_endpoint: '0.0.0.0:81'
          latency_histogram_buckets: [10ms, 25ms, 50ms, 100ms, 250ms, 500ms, 1s, 2500ms, 3s, 4s, 5s, 10s, 30s, 45s]

        tail_sampling:
          policies:
            - name: errors
              type: status_code
              status_code:
                status_codes:
                  - ERROR
            - name: slow
              type: latency
              latency:
                threshold_ms: 1000
            - name: probabilistic
              type: probabilistic
              probabilistic:
                sampling_percentage: 10

        remote_write:
        - endpoint: tempo-eu-west-0.grafana.net:443
          basic_auth:
            username: ${GRAFANA_TRACES_USERNAME}
            password: ${GRAFANA_PASSWORD}
        receivers:
          otlp:
            protocols:
              grpc:
        scrape_configs:
        - job_name: "kubernetes-pods"
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: namespace
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: pod
